<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Criar Novo Puzzle</title>
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    .step-card {
      border: 1px solid #ccc;
      padding: 15px;
      margin-bottom: 15px;
    }
  </style>
</head>
<body class="bg-light">
  <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
    <div class="container-fluid">
      <a class="navbar-brand" href="/manage-puzzles.html">Voltar a Gerir Puzzles</a>
    </div>
  </nav>

  <div class="container mt-5">
    <h2 class="text-center mb-4">Criar Novo Puzzle</h2>

    <!-- Formulário de Dados do Puzzle -->
    <form id="create-puzzle-form">
      <div class="mb-3">
        <label for="title" class="form-label">Título do Puzzle</label>
        <input type="text" id="title" name="title" class="form-control" required />
      </div>
      <div class="mb-3">
        <label for="description" class="form-label">Descrição do Puzzle</label>
        <textarea id="description" name="description" class="form-control" rows="3" required></textarea>
      </div>
      <div class="mb-3">
        <label for="icon" class="form-label">Ícone do Puzzle</label>
        <div class="input-group">
          <input type="text" id="icon" name="icon" class="form-control" readonly />
          <button type="button" class="btn btn-secondary" onclick="openImageSelector('icon')">Selecionar Imagem</button>
        </div>
      </div>
      <div class="mb-3">
        <label class="form-label">Ilha:</label>
        <p id="island-name" class="form-control-plaintext"></p>
        <input type="hidden" id="island-id" name="island" />
      </div>

      <!-- Detalhes do Puzzle -->
      <h4 class="mt-4">Detalhes do Puzzle</h4>
      <div id="steps-container"></div>
      <button type="button" class="btn btn-secondary w-100" id="add-step-button" onclick="addStep()">Adicionar Passo</button>

      <button type="submit" class="btn btn-primary w-100 mt-3" id="save-puzzle-button">Salvar Puzzle</button>
    </form>
  </div>

  <script>
    let stepCounter = 1;

    // Função para carregar as informações da ilha
    async function loadIslands() {
      try {
        const urlParams = new URLSearchParams(window.location.search);
        const selectedIslandId = urlParams.get('island');

        if (!selectedIslandId) {
          alert('ID da ilha não encontrado. Por favor, selecione uma ilha antes de criar o puzzle.');
          window.location.href = '/manage-puzzles.html'; // Redireciona para a página de gerenciamento de puzzles
          return;
        }

        const response = await fetch(`http://localhost:5000/api/islands/${selectedIslandId}`);
        if (!response.ok) {
          throw new Error('Erro ao buscar informações da ilha.');
        }

        const island = await response.json();

        // Exibe o nome da ilha e armazena o ID
        document.getElementById('island-name').textContent = island.name;
        document.getElementById('island-id').value = island._id;
      } catch (error) {
        console.error('Erro ao carregar informações da ilha:', error);
        alert('Ocorreu um erro ao carregar as informações da ilha. Por favor, tente novamente.');
      }
    }

    // Função para abrir a pop-up de seleção de imagem
    function openImageSelector(fieldId) {
      const popup = window.open('/image-selector.html', 'ImageSelector', 'width=800,height=600');
      
      // Escuta mensagens da pop-up
      window.addEventListener('message', (event) => {
        const { imageId } = event.data;
        if (imageId) {
          document.getElementById(fieldId).value = imageId; // Preenche o campo com o ID da imagem
        }
      });
    }

    // Função para adicionar um novo passo
    function addStep() {
      const stepsContainer = document.getElementById('steps-container');

      const stepCard = document.createElement('div');
      stepCard.className = 'step-card';
      stepCard.innerHTML = `
        <h5>Passo ${stepCounter}</h5>
        <div class="mb-3">
          <label class="form-label">Gerenciar Personagens</label>
          <div class="row mb-3">
            <div class="col-md-6">
              <label class="form-label">Usar/Copiar Personagens de Outro Passo</label>
              <div class="input-group">
                <input type="number" class="form-control" placeholder="Número do passo" id="copy-from-step-${stepCounter}" />
                <button type="button" class="btn btn-info" onclick="useCharacters(${stepCounter})">Usar</button>
                <button type="button" class="btn btn-warning" onclick="copyCharacters(${stepCounter})">Copiar</button>
              </div>
            </div>
          </div>
          <div id="characters-${stepCounter}"></div>
          <button type="button" class="btn btn-sm btn-info mt-2" onclick="addCharacter(${stepCounter})">Adicionar Personagem</button>
        </div>
        <div class="mb-3">
          <label for="step-body-${stepCounter}" class="form-label">Texto Principal</label>
          <textarea id="step-body-${stepCounter}" class="form-control" rows="2" required></textarea>
        </div>
        <div id="challenge-${stepCounter}" style="display: none;">
          <div class="mb-3">
            <label for="challenge-question-${stepCounter}" class="form-label">Pergunta do Desafio</label>
            <textarea id="challenge-question-${stepCounter}" class="form-control" rows="2" placeholder="Pergunta do desafio"></textarea>
          </div>
          <div class="mb-3">
            <label for="challenge-options-${stepCounter}" class="form-label">Opções de Resposta (separadas por vírgula)</label>
            <input type="text" id="challenge-options-${stepCounter}" class="form-control" placeholder="Opção 1, Opção 2, Opção 3" />
          </div>
          <div class="mb-3">
            <label for="correct-answer-${stepCounter}" class="form-label">Resposta Correta</label>
            <input type="text" id="correct-answer-${stepCounter}" class="form-control" placeholder="Resposta correta" />
          </div>
        </div>
        <button type="button" class="btn btn-secondary w-100 mt-2" id="copy-text-button-${stepCounter}" onclick="copyPreviousStepText(${stepCounter})" ${
            stepCounter === 1 ? 'disabled' : ''
          }>Copiar Texto do Passo Anterior</button>
        <button type="button" class="btn btn-secondary w-100" onclick="toggleChallenge(${stepCounter})">Adicionar Desafio</button>
      `;
      stepsContainer.appendChild(stepCard);

      stepCounter++;
    }

    // Função para copiar o texto do passo anterior
    function copyPreviousStepText(stepNumber) {
      if (stepNumber <= 1) {
        alert('Não há passo anterior para copiar.');
        return;
      }

      const previousStepBody = document.getElementById(`step-body-${stepNumber - 1}`).value.trim();
      const currentStepBody = document.getElementById(`step-body-${stepNumber}`);

      if (!previousStepBody) {
        alert('O passo anterior não possui texto para copiar.');
        return;
      }

      currentStepBody.value = previousStepBody; // Copia o texto do passo anterior
    }

    // Função para alternar a visibilidade do desafio
    function toggleChallenge(stepNumber) {
      const challengeDiv = document.getElementById(`challenge-${stepNumber}`);
      if (challengeDiv.style.display === 'none') {
        challengeDiv.style.display = 'block'; // Mostra o desafio
      } else {
        challengeDiv.style.display = 'none'; // Oculta o desafio
      }
    }

    // Função para usar personagens de outro passo
    function useCharacters(stepNumber) {
      const sourceStep = document.getElementById(`copy-from-step-${stepNumber}`).value.trim();
      if (!sourceStep || isNaN(sourceStep)) {
        alert('Por favor, insira um número de passo válido.');
        return;
      }

      const sourceCharactersContainer = document.getElementById(`characters-${sourceStep}`);
      const targetCharactersContainer = document.getElementById(`characters-${stepNumber}`);

      if (!sourceCharactersContainer || sourceCharactersContainer.children.length === 0) {
        alert('O passo selecionado não possui personagens.');
        return;
      }

      // Clona os personagens diretamente (sem permitir edição)
      targetCharactersContainer.innerHTML = '';
      Array.from(sourceCharactersContainer.children).forEach(characterDiv => {
        const clone = characterDiv.cloneNode(true);
        targetCharactersContainer.appendChild(clone);
      });
    }

    // Função para copiar personagens de outro passo
    function copyCharacters(stepNumber) {
      const sourceStep = document.getElementById(`copy-from-step-${stepNumber}`).value.trim();
      if (!sourceStep || isNaN(sourceStep)) {
        alert('Por favor, insira um número de passo válido.');
        return;
      }

      const sourceCharactersContainer = document.getElementById(`characters-${sourceStep}`);
      const targetCharactersContainer = document.getElementById(`characters-${stepNumber}`);

      if (!sourceCharactersContainer || sourceCharactersContainer.children.length === 0) {
        alert('O passo selecionado não possui personagens.');
        return;
      }

      // Clona os personagens permitindo edição
      targetCharactersContainer.innerHTML = '';
      Array.from(sourceCharactersContainer.children).forEach(characterDiv => {
        const clone = characterDiv.cloneNode(true);
        targetCharactersContainer.appendChild(clone);
      });
    }

    // Função para adicionar um personagem a um passo
    function addCharacter(stepNumber) {
      const charactersContainer = document.getElementById(`characters-${stepNumber}`);
      
      // Contador interno para garantir IDs únicos dentro do mesmo passo
      const characterCounter = charactersContainer.children.length + 1;

      const characterDiv = document.createElement('div');
      characterDiv.className = 'mb-2';
      characterDiv.innerHTML = `
        <div class="row">
          <div class="col-md-6">
            <label class="form-label">Imagem do Personagem</label>
            <div class="input-group">
              <input type="text" id="character-image-${stepNumber}-${characterCounter}" class="form-control" placeholder="ID da imagem" readonly />
              <button type="button" class="btn btn-secondary" onclick="openImageSelector('character-image-${stepNumber}-${characterCounter}')">Selecionar Imagem</button>
            </div>
          </div>
          <div class="col-md-6">
            <label class="form-label">Legenda (opcional)</label>
            <input type="text" class="form-control" placeholder="Legenda" />
          </div>
        </div>
        <div class="row">
          <div class="col-md-6">
            <label class="form-label">Posição</label>
            <select class="form-select" required>
              <option value="left">Esquerda</option>
              <option value="right">Direita</option>
            </select>
          </div>
          <div class="col-md-6">
            <label class="form-label">Ordem</label>
            <input type="number" class="form-control" placeholder="Ordem" required />
          </div>
        </div>
      `;
      charactersContainer.appendChild(characterDiv);
    }

    // Envio do formulário
    document.getElementById('create-puzzle-form').addEventListener('submit', async (e) => {
        e.preventDefault();

        const formData = new FormData(e.target);
        const title = formData.get('title');
        const description = formData.get('description');
        const icon = formData.get('icon');
        const island = formData.get('island');

        if (!title || !description || !icon || !island) {
            alert('Por favor, preencha todos os campos obrigatórios.');
            return;
        }

        const steps = [];
        document.querySelectorAll('.step-card').forEach((stepCard, index) => {
            const stepBody = stepCard.querySelector(`#step-body-${index + 1}`).value.trim();
            const challengeQuestion = stepCard.querySelector(`#challenge-question-${index + 1}`).value.trim();
            const challengeOptions = stepCard.querySelector(`#challenge-options-${index + 1}`).value.split(',').map(option => option.trim());
            const correctAnswer = stepCard.querySelector(`#correct-answer-${index + 1}`).value.trim();

            const characters = [];
            stepCard.querySelectorAll('#characters div.row').forEach(characterRow => {
            const image = characterRow.querySelector('input[type="text"]').value.trim();
            const label = characterRow.querySelector('input[type="text"]').value.trim();
            const position = characterRow.querySelector('select').value;
            const order = parseInt(characterRow.querySelector('input[type="number"]').value, 10);

            characters.push({ image, label, position, order });
            });

            const step = {
            stepNumber: index + 1,
            body: stepBody,
            characters,
            };

            if (challengeQuestion && challengeOptions.length > 0 && correctAnswer) {
            step.challenge = {
                question: challengeQuestion,
                options: challengeOptions,
                correctAnswer,
            };
            }

            steps.push(step);
        });

        const puzzleData = {
            title,
            description,
            icon,
            island,
        };

        try {
            // Primeira chamada: Criar o puzzle
            const createPuzzleResponse = await fetch('http://localhost:5000/api/puzzles', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(puzzleData),
            });

            const createPuzzleResult = await createPuzzleResponse.json();
            if (!createPuzzleResponse.ok) {
            throw new Error(createPuzzleResult.message || 'Erro ao criar o puzzle.');
            }

            const puzzleId = createPuzzleResult.puzzle._id;

            // Segunda chamada: Criar os detalhes do puzzle
            const detailsData = { steps };
            const createDetailsResponse = await fetch(`http://localhost:5000/api/puzzles/${puzzleId}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(detailsData),
            });

            const createDetailsResult = await createDetailsResponse.json();
            if (!createDetailsResponse.ok) {
            throw new Error(createDetailsResult.message || 'Erro ao criar os detalhes do puzzle.');
            }

            alert('Puzzle criado com sucesso!');
            window.location.href = '/manage-puzzles.html';
        } catch (error) {
            console.error('Erro ao criar puzzle:', error);
            alert(`Ocorreu um erro ao criar o puzzle: ${error.message}`);
        }
    });

    // Carrega as informações da ilha ao iniciar a página
    loadIslands();

    // Adiciona o primeiro passo automaticamente
    addStep();
  </script>
</body>
</html>