<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Editar Puzzle</title>
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    .step-card {
      border: 1px solid #ccc;
      padding: 15px;
      margin-bottom: 15px;
    }
  </style>
</head>
<body class="bg-light">
  <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
    <div class="container-fluid">
      <a class="navbar-brand" href="/manage-puzzles.html">Voltar a Gerir Puzzles</a>
    </div>
  </nav>

  <div class="container mt-5">
    <h2 class="text-center mb-4">Editar Puzzle</h2>

    <!-- Formulário de Dados do Puzzle -->
    <form id="edit-puzzle-form">
      <input type="hidden" id="puzzle-id" name="id" />
      
      <div class="mb-3">
        <label for="title" class="form-label">Título do Puzzle</label>
        <input type="text" id="title" name="title" class="form-control" required />
      </div>
      <div class="mb-3">
        <label for="description" class="form-label">Descrição do Puzzle</label>
        <textarea id="description" name="description" class="form-control" rows="3" required></textarea>
      </div>
      <div class="mb-3">
        <label for="icon" class="form-label">Ícone do Puzzle</label>
        <div class="input-group">
          <input type="text" id="icon" name="icon" class="form-control" readonly />
          <button type="button" class="btn btn-secondary" onclick="openImageSelector('icon')">Selecionar Imagem</button>
        </div>
      </div>
      <div class="mb-3">
        <label class="form-label">Ilha</label>
        <p id="island-name" class="form-control-plaintext"></p>
        <input type="hidden" id="island-id" name="island" />
      </div>

      <!-- Detalhes do Puzzle -->
      <h4 class="mt-4">Detalhes do Puzzle</h4>
      <div id="steps-container"></div>
      <button type="button" class="btn btn-secondary w-100" id="add-step-button" onclick="addStep()">Adicionar Passo</button>

      <button type="submit" class="btn btn-primary w-100 mt-3" id="save-puzzle-button">Salvar Alterações</button>
    </form>
  </div>

  <script>
    let stepCounter = 1;

    // Função para carregar os dados do puzzle
    async function loadPuzzle(puzzleId) {
      try {
        const response = await fetch(`http://localhost:5000/api/puzzles/${puzzleId}`);
        if (!response.ok) {
          throw new Error('Erro ao buscar dados do puzzle.');
        }

        const puzzle = await response.json();

        // Preencher os campos do cabeçalho
        document.getElementById('puzzle-id').value = puzzle._id;
        document.getElementById('title').value = puzzle.title;
        document.getElementById('description').value = puzzle.description;
        document.getElementById('icon').value = puzzle.icon;
        document.getElementById('island-id').value = puzzle.island;
        document.getElementById('island-name').textContent = puzzle.islandName || 'Ilha não encontrada';

        // Carregar os detalhes (se existirem)
        if (puzzle.details && puzzle.details.steps) {
          puzzle.details.steps.forEach(step => {
            addStep(step);
          });
        }
      } catch (error) {
        console.error('Erro ao carregar dados do puzzle:', error);
        alert('Ocorreu um erro ao carregar os dados do puzzle. Por favor, tente novamente.');
      }
    }

    // Função para adicionar um novo passo (pré-preenchido ou vazio)
    function addStep(stepData = null) {
      const stepsContainer = document.getElementById('steps-container');

      const stepCard = document.createElement('div');
      stepCard.className = 'step-card';
      stepCard.innerHTML = `
        <h5>Passo ${stepCounter}</h5>
        <div class="mb-3">
          <label class="form-label">Gerenciar Personagens</label>
          <div id="characters-${stepCounter}"></div>
          <button type="button" class="btn btn-sm btn-info mt-2" onclick="addCharacter(${stepCounter})">Adicionar Personagem</button>
        </div>
        <div class="mb-3">
          <label for="step-body-${stepCounter}" class="form-label">Texto Principal</label>
          <textarea id="step-body-${stepCounter}" class="form-control" rows="5" required>${stepData?.body || ''}</textarea>
        </div>
        <div id="challenge-${stepCounter}" style="display: ${stepData?.challenge ? 'block' : 'none'};">
          <div class="mb-3">
            <label for="challenge-question-${stepCounter}" class="form-label">Pergunta do Desafio</label>
            <textarea id="challenge-question-${stepCounter}" class="form-control" rows="2">${stepData?.challenge?.question || ''}</textarea>
          </div>
          <div class="mb-3">
            <label for="challenge-options-${stepCounter}" class="form-label">Opções de Resposta (separadas por vírgula)</label>
            <input type="text" id="challenge-options-${stepCounter}" class="form-control" value="${stepData?.challenge?.options?.join(', ') || ''}" />
          </div>
          <div class="mb-3">
            <label for="correct-answer-${stepCounter}" class="form-label">Resposta Correta</label>
            <input type="text" id="correct-answer-${stepCounter}" class="form-control" value="${stepData?.challenge?.correctAnswer || ''}" />
          </div>
        </div>
        <button type="button" class="btn btn-secondary w-100" onclick="toggleChallenge(${stepCounter})">${stepData?.challenge ? 'Remover Desafio' : 'Adicionar Desafio'}</button>
      `;
      stepsContainer.appendChild(stepCard);

      // Preencher personagens (se existirem)
      if (stepData?.characters) {
        stepData.characters.forEach(character => {
          addCharacter(stepCounter, character);
        });
      }

      stepCounter++;
    }

    // Função para alternar a visibilidade do desafio
    function toggleChallenge(stepNumber) {
      const challengeDiv = document.getElementById(`challenge-${stepNumber}`);
      if (challengeDiv.style.display === 'none') {
        challengeDiv.style.display = 'block'; // Mostra o desafio
      } else {
        challengeDiv.style.display = 'none'; // Oculta o desafio
      }
    }

    // Função para adicionar um personagem a um passo (pré-preenchido ou vazio)
    function addCharacter(stepNumber, characterData = null) {
      const charactersContainer = document.getElementById(`characters-${stepNumber}`);

      const characterDiv = document.createElement('div');
      characterDiv.className = 'mb-2';
      characterDiv.innerHTML = `
        <div class="row">
          <div class="col-md-6">
            <label class="form-label">Imagem do Personagem</label>
            <div class="input-group">
              <input type="text" class="form-control" value="${characterData?.image || ''}" readonly />
              <button type="button" class="btn btn-secondary" onclick="openImageSelector(this.previousElementSibling.id)">Selecionar Imagem</button>
            </div>
          </div>
          <div class="col-md-6">
            <label class="form-label">Legenda (opcional)</label>
            <input type="text" class="form-control" value="${characterData?.label || ''}" />
          </div>
        </div>
        <div class="row">
          <div class="col-md-6">
            <label class="form-label">Posição</label>
            <select class="form-select" required>
              <option value="left" ${characterData?.position === 'left' ? 'selected' : ''}>Esquerda</option>
              <option value="right" ${characterData?.position === 'right' ? 'selected' : ''}>Direita</option>
            </select>
          </div>
          <div class="col-md-6">
            <label class="form-label">Ordem</label>
            <input type="number" class="form-control" value="${characterData?.order || ''}" required />
          </div>
        </div>
      `;
      charactersContainer.appendChild(characterDiv);
    }

    // Função para abrir a pop-up de seleção de imagem
    function openImageSelector(fieldId) {
      const popup = window.open('/image-selector.html', 'ImageSelector', 'width=800,height=600');
      
      // Escuta mensagens da pop-up
      window.addEventListener('message', (event) => {
        const { imageId } = event.data;
        if (imageId) {
          document.getElementById(fieldId).value = imageId; // Preenche o campo com o ID da imagem
        }
      });
    }

    // Envio do formulário
    document.getElementById('edit-puzzle-form').addEventListener('submit', async (e) => {
      e.preventDefault();

      const formData = new FormData(e.target);
      const puzzleId = formData.get('id');
      const title = formData.get('title');
      const description = formData.get('description');
      const icon = formData.get('icon');
      const island = formData.get('island');

      if (!title || !description || !icon || !island) {
        alert('Por favor, preencha todos os campos obrigatórios.');
        return;
      }

      const steps = [];
      document.querySelectorAll('.step-card').forEach((stepCard, index) => {
        const stepBody = stepCard.querySelector(`#step-body-${index + 1}`).value.trim();
        const challengeQuestion = stepCard.querySelector(`#challenge-question-${index + 1}`)?.value.trim();
        const challengeOptions = stepCard.querySelector(`#challenge-options-${index + 1}`)?.value.split(',').map(option => option.trim());
        const correctAnswer = stepCard.querySelector(`#correct-answer-${index + 1}`)?.value.trim();

        const characters = [];
        stepCard.querySelectorAll('#characters div.row').forEach(characterRow => {
          const image = characterRow.querySelector('input[type="text"]').value.trim();
          const label = characterRow.querySelector('input[type="text"]').value.trim();
          const position = characterRow.querySelector('select').value;
          const order = parseInt(characterRow.querySelector('input[type="number"]').value, 10);

          characters.push({ image, label, position, order });
        });

        const step = {
          stepNumber: index + 1,
          body: stepBody,
          characters,
        };

        if (challengeQuestion && challengeOptions.length > 0 && correctAnswer) {
          step.challenge = {
            question: challengeQuestion,
            options: challengeOptions,
            correctAnswer,
          };
        }

        steps.push(step);
      });

      const puzzleData = {
        title,
        description,
        icon,
        island,
      };

      const detailsData = { steps };

      try {
        // Atualizar o cabeçalho do puzzle
        const updatePuzzleResponse = await fetch(`http://localhost:5000/api/puzzles/${puzzleId}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(puzzleData),
        });

        const updatePuzzleResult = await updatePuzzleResponse.json();
        if (!updatePuzzleResponse.ok) {
          throw new Error(updatePuzzleResult.message || 'Erro ao atualizar o cabeçalho do puzzle.');
        }

        // Atualizar os detalhes do puzzle
        const updateDetailsResponse = await fetch(`http://localhost:5000/api/puzzles/${puzzleId}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(detailsData),
        });

        const updateDetailsResult = await updateDetailsResponse.json();
        if (!updateDetailsResponse.ok) {
          throw new Error(updateDetailsResult.message || 'Erro ao atualizar os detalhes do puzzle.');
        }

        alert('Puzzle atualizado com sucesso!');
        window.location.href = '/manage-puzzles.html';
      } catch (error) {
        console.error('Erro ao atualizar puzzle:', error);
        alert(`Ocorreu um erro ao atualizar o puzzle: ${error.message}`);
      }
    });

    // Carregar os dados do puzzle ao iniciar a página
    const urlParams = new URLSearchParams(window.location.search);
    const puzzleId = urlParams.get('id');
    if (puzzleId) {
      loadPuzzle(puzzleId);
    } else {
      alert('ID do puzzle não encontrado.');
      window.location.href = '/manage-puzzles.html';
    }
  </script>
</body>
</html>