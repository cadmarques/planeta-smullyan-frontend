<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Criar Nova Ilha</title>
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    .selected {
      border: 2px solid blue; /* Borda azul para indicar seleção */
      background-color: #e9f7ff; /* Fundo claro para melhor contraste */
    }
  </style>
  <script>
    // Configuração de URLs dinâmicas
    const API_BASE_URL = window.location.hostname === 'localhost' 
        ? 'http://localhost:5000' 
        : 'https://planeta-smullyan-backend.onrender.com/'; // Substitua pela URL do backend no Render

    const FRONTEND_BASE_URL = window.location.hostname === 'localhost' 
        ? 'http://localhost:3000' 
        : 'https://cadmarques.github.io/planeta-smullyan-frontend'; // Substitua pela URL do GitHub Pages
  </script>
</head>
<body class="bg-light">
  <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
    <div class="container-fluid">
      <a class="navbar-brand" href="/manage-islands.html">Voltar a Gerir Ilhas</a>
    </div>
  </nav>

  <div class="container mt-5">
    <h2 class="text-center mb-4">Criar Nova Ilha</h2>

    <!-- Formulário de Dados da Ilha -->
    <form id="create-island-form">
      <div class="mb-3">
        <label for="name" class="form-label">Nome da Ilha</label>
        <input type="text" id="name" name="name" class="form-control" required />
      </div>
      <div class="mb-3">
        <label for="description" class="form-label">Descrição da Ilha</label>
        <textarea id="description" name="description" class="form-control" rows="3" required></textarea>
      </div>

      <!-- Campo de Pesquisa de Imagens -->
      <div class="mb-3">
        <label for="image-search" class="form-label">Pesquisar Banner</label>
        <input type="text" id="image-search" class="form-control" placeholder="Pesquisar por nome ou descrição (mínimo 3 letras)" />
      </div>

      <!-- Grid de Imagens -->
      <div id="image-grid" class="row"></div>

      <button type="submit" class="btn btn-primary w-100" disabled id="submit-button">Avançar para Definir Limites</button>
    </form>
  </div>

  <script>
    let selectedImageId = null;
    let selectedCard = null;

    // Função para carregar imagens
    async function loadImages(query = '') {
      try {
        const response = await fetch(`${API_BASE_URL}/api/images/search${query ? `?query=${encodeURIComponent(query)}` : ''}`);
        const images = await response.json();

        const grid = document.getElementById('image-grid');
        grid.innerHTML = ''; // Limpa o conteúdo anterior

        if (response.ok) {
          if (images.length === 0) {
            grid.innerHTML = '<p class="text-center text-muted">Nenhuma imagem encontrada.</p>';
            return;
          }

          images.forEach(image => {
            const card = document.createElement('div');
            card.className = 'col-md-4 mb-3';
            card.innerHTML = `
              <div class="card" data-image-id="${image._id}" style="cursor: pointer;">
                <div class="card-body">
                  <h6 class="card-title">${image.name}</h6>
                  <p class="card-text">${image.description}</p>
                  <small class="text-muted">Criado em: ${new Date(image.createdAt).toLocaleDateString()}</small>
                </div>
              </div>
            `;
            card.querySelector('.card').addEventListener('click', () => selectImage(image._id, card.querySelector('.card')));
            grid.appendChild(card);
          });
        } else {
          alert(images.message || 'Erro ao carregar imagens.');
        }
      } catch (error) {
        console.error('Erro ao carregar imagens:', error);
        alert('Ocorreu um erro inesperado ao carregar imagens.');
      }
    }

    // Função para selecionar uma imagem
    function selectImage(imageId, cardElement) {
      if (selectedCard) {
        selectedCard.classList.remove('selected'); // Remove o destaque do card anterior
      }

      selectedImageId = imageId;
      selectedCard = cardElement;
      selectedCard.classList.add('selected'); // Adiciona o destaque ao card atual
      validateForm(); // Valida o formulário após selecionar a imagem
      //alert('Imagem selecionada!');
    }

    // Função para validar o formulário
    function validateForm() {
      const name = document.getElementById('name').value.trim();
      const description = document.getElementById('description').value.trim();
      const submitButton = document.getElementById('submit-button');

      // Habilita o botão apenas se todos os campos obrigatórios estiverem preenchidos
      if (name && description && selectedImageId) {
        submitButton.disabled = false;
      } else {
        submitButton.disabled = true;
      }
    }

    // Evento de pesquisa
    document.getElementById('image-search').addEventListener('input', (e) => {
      const query = e.target.value.trim();
      if (query.length >= 3) {
        loadImages(query); // Executa a pesquisa se o texto tiver pelo menos 3 caracteres
      } else if (query.length === 0) {
        loadImages(); // Carrega as 10 imagens mais recentes se o campo estiver vazio
      }
    });

    // Eventos para validar o formulário enquanto o usuário preenche os campos
    document.getElementById('name').addEventListener('input', validateForm);
    document.getElementById('description').addEventListener('input', validateForm);

    // Carrega as imagens iniciais
    loadImages();

    // Envio do formulário
    document.getElementById('create-island-form').addEventListener('submit', (e) => {
      e.preventDefault();

      if (!selectedImageId) {
        alert('Por favor, selecione uma imagem de banner.');
        return;
      }

      const formData = new FormData(e.target);
      const name = formData.get('name');
      const description = formData.get('description');

      const queryString = new URLSearchParams({
        name,
        description,
        banner: selectedImageId,
      }).toString();
      window.location.href = `/map-helper?${queryString}`;
    });
  </script>
</body>
</html>